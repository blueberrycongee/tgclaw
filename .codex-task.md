# Phase 6 Fix: Session Management Wiring + highlight.js Optimization

## Current State
- state.js already has sessions[] and currentSessionKey
- styles.css already has code-block-wrapper/hljs styles  
- chat.js has code highlighting + copy button, but uses FULL highlight.js, and has NO session wiring
- sidebar.js has NO renderSessions function, selectItem does NOT handle session items
- index.html has NO session-list container
- settings.js has NO session sync

## Task 1: index.html - add session-list container
In src/renderer/index.html, add a `<div id="session-list"></div>` BEFORE the `<div id="project-list"></div>` line. Add a comment `<!-- Sessions -->` above it.

Commit: "feat(ui): add session-list container to sidebar"

## Task 2: sidebar.js - add renderSessions + update selectItem
In src/renderer/sidebar.js:

A) Add `reloadChatHistory: () => {}` to the deps object.

B) Add and export a `renderSessions()` function that:
- Gets `document.getElementById("session-list")`, returns if null
- Filters `state.sessions` to only sessions with a non-empty sessionKey that is not "default"
- Renders each as a sidebar-item div with `data-id="session:{key}"` and `data-session-key="{key}"`, icon ðŸ’¬, showing label or key
- Adds click listeners that call `selectItem("session:" + key)`

C) Update `selectItem(id)` to handle session items:
- Detect `const isSessionItem = id.startsWith("session:");`
- Compute nextSessionKey: if isSessionItem -> `id.slice(8)`, if id==="openclaw" -> "default", else null
- Track if session changed: `const shouldReload = typeof nextSessionKey === "string" && state.currentSessionKey !== nextSessionKey;`
- Update `state.currentSessionKey` if nextSessionKey is a string
- Change the `if (id === 'openclaw')` branch to `if (id === 'openclaw' || isSessionItem)` so sessions show the chat panel
- At end of that branch, if shouldReload, call `deps.reloadChatHistory()`

Commit: "feat(sidebar): add session rendering and switching support"

## Task 3: chat.js - wire session fetching on connect
In src/renderer/chat.js:

A) Add `import { renderSessions } from './sidebar.js';` at the top imports

B) Change `gateway.on('connected', () => {` to `gateway.on('connected', async () => {`
After the existing `void loadChatHistory();` line, add:
```
try {
  const result = await gateway.sessionsList();
  state.sessions = Array.isArray(result?.sessions) ? result.sessions : (Array.isArray(result) ? result : []);
  renderSessions();
} catch { /* no-op */ }
```

C) Change `gateway.on('disconnected', () => updateConnectionStatus(false));` to:
```
gateway.on('disconnected', () => {
  updateConnectionStatus(false);
  state.sessions = [];
  renderSessions();
});
```

D) Check src/renderer/main.js - if configureSidebar call does NOT include reloadChatHistory, add it. The function is called `loadChatHistory` in chat.js - check the actual export name and use that.

Commit: "feat(chat): fetch and render sessions on gateway connect"

## Task 4: chat.js - optimize highlight.js bundle
In src/renderer/chat.js:

Replace `import hljs from 'highlight.js';` with `import hljs from 'highlight.js/lib/core';`

Add individual language imports and register them:
```js
import javascript from 'highlight.js/lib/languages/javascript';
import typescript from 'highlight.js/lib/languages/typescript';
import python from 'highlight.js/lib/languages/python';
import bash from 'highlight.js/lib/languages/bash';
import jsonLang from 'highlight.js/lib/languages/json';
import xml from 'highlight.js/lib/languages/xml';
import cssLang from 'highlight.js/lib/languages/css';
import rust from 'highlight.js/lib/languages/rust';
import go from 'highlight.js/lib/languages/go';
import java from 'highlight.js/lib/languages/java';
import c from 'highlight.js/lib/languages/c';
import cpp from 'highlight.js/lib/languages/cpp';
import sql from 'highlight.js/lib/languages/sql';
import yaml from 'highlight.js/lib/languages/yaml';
import markdownLang from 'highlight.js/lib/languages/markdown';
import diffLang from 'highlight.js/lib/languages/diff';
import shell from 'highlight.js/lib/languages/shell';

[
  ['javascript', javascript], ['typescript', typescript], ['python', python],
  ['bash', bash], ['json', jsonLang], ['xml', xml], ['css', cssLang],
  ['rust', rust], ['go', go], ['java', java], ['c', c], ['cpp', cpp],
  ['sql', sql], ['yaml', yaml], ['markdown', markdownLang],
  ['diff', diffLang], ['shell', shell],
].forEach(([name, lang]) => hljs.registerLanguage(name, lang));
```

Note: use `jsonLang`, `cssLang`, `markdownLang`, `diffLang` as import names to avoid conflicts with JS reserved words or existing variables.

Commit: "perf(chat): optimize highlight.js with selective language imports"

## Verification
Run `npm run build:renderer` after each commit. Final bundle JS should be significantly smaller than 1.4MB.
